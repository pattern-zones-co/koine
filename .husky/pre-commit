#!/bin/sh
# Pre-commit hook for koine monorepo
# Runs linting, formatting, type checking, and security scans

# Get list of staged files by type
# Note: grep returns exit 1 when no matches, so we use || true to avoid script exit
STAGED_TS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep "\.ts$" || true)
STAGED_PY_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep "\.py$" || true)
STAGED_JSON_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep "\.json$" | grep -v "package-lock.json" | grep -v "bun.lock" || true)
STAGED_SH_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep "\.sh$" || true)
STAGED_GH_WORKFLOWS=$(git diff --cached --name-only --diff-filter=ACM | grep "^\.github/workflows/.*\.ya\?ml$" || true)
STAGED_DOCKER_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E "(Dockerfile|docker-compose.*\.ya?ml)$" || true)

# Flag to track if any checks failed
CHECKS_FAILED=0

# TypeScript linting and formatting with Biome
if [ -n "$STAGED_TS_FILES" ] || [ -n "$STAGED_JSON_FILES" ]; then
    echo "üì¶ Running TypeScript linting and formatting..."

    if [ -d "node_modules" ] && [ -f "node_modules/.bin/biome" ]; then
        # 1. Run Biome format with auto-fix on staged files
        echo "Running Biome formatter on staged files..."
        STAGED_FILES_FOR_BIOME=""
        for file in $STAGED_TS_FILES $STAGED_JSON_FILES; do
            if [ -f "$file" ]; then
                STAGED_FILES_FOR_BIOME="$STAGED_FILES_FOR_BIOME $file"
            fi
        done
        if [ -n "$STAGED_FILES_FOR_BIOME" ]; then
            # shellcheck disable=SC2086
            if bun biome format --write $STAGED_FILES_FOR_BIOME; then
                echo "‚úÖ Biome formatting complete!"
                # Re-stage formatted files
                for file in $STAGED_TS_FILES $STAGED_JSON_FILES; do
                    if [ -f "$file" ]; then
                        git add "$file"
                    fi
                done
            else
                echo "‚ö†Ô∏è  Biome formatter encountered issues (continuing anyway)"
            fi
        fi

        # 2. Run Biome linting (BLOCKING - must pass)
        echo "Running Biome linting..."
        # shellcheck disable=SC2086
        if ! bun biome check $STAGED_FILES_FOR_BIOME 2>&1; then
            echo "‚ùå Biome found linting issues! Please fix them before committing."
            echo "üí° To fix: bun biome check --write ."
            CHECKS_FAILED=1
        else
            echo "‚úÖ No Biome linting issues found!"
        fi
    else
        echo "‚ö†Ô∏è  Dependencies not installed. Skipping linting."
        echo "Run: bun install"
    fi
fi

# TypeScript type checking (no emit, just check types)
if [ -n "$STAGED_TS_FILES" ]; then
    echo "üîç Running TypeScript type checking..."

    if [ -d "node_modules" ]; then
        # Type check each package without emitting files
        TYPE_CHECK_FAILED=0
        for pkg_dir in packages/gateway packages/sdks/typescript; do
            if [ -f "$pkg_dir/tsconfig.json" ]; then
                if ! bun tsc --noEmit -p "$pkg_dir/tsconfig.json" 2>&1; then
                    TYPE_CHECK_FAILED=1
                fi
            fi
        done
        if [ $TYPE_CHECK_FAILED -eq 1 ]; then
            echo "‚ùå TypeScript errors found! Please fix them before committing."
            CHECKS_FAILED=1
        else
            echo "‚úÖ No TypeScript errors found!"
        fi
    fi
fi

# Python linting and formatting with Ruff
if [ -n "$STAGED_PY_FILES" ]; then
    echo "üêç Running Python linting and formatting..."

    if command -v ruff >/dev/null 2>&1; then
        echo "Checking for linting errors with auto-fix..."
        # Run check with auto-fix (this will fix what it can)
        # shellcheck disable=SC2086
        ruff check --fix $STAGED_PY_FILES 2>&1

        # Check if there are any remaining unfixable errors
        # shellcheck disable=SC2086
        if ! ruff check $STAGED_PY_FILES 2>&1; then
            echo "‚ùå Unfixable linting errors found! Please fix the above issues before committing."
            echo "To check linting manually, run: ruff check ."
            CHECKS_FAILED=1
        else
            echo "‚úÖ No linting errors found!"
        fi

        # Format staged Python files
        echo "Formatting staged Python files..."
        # shellcheck disable=SC2086
        ruff format $STAGED_PY_FILES
        echo "‚úÖ Python formatting complete!"

        # Re-stage any files that were modified by formatting
        for file in $STAGED_PY_FILES; do
            if [ -f "$file" ]; then
                git add "$file"
            fi
        done
    else
        echo "‚ö†Ô∏è  Ruff not found locally. Skipping Python linting."
        echo "Install: pip install ruff"
    fi
fi

# Shell script linting with shellcheck
if [ -n "$STAGED_SH_FILES" ]; then
    echo "üêö Running shell script linting..."

    if command -v shellcheck >/dev/null 2>&1; then
        echo "Running shellcheck..."
        SHELLCHECK_FAILED=0
        for script in $STAGED_SH_FILES; do
            if ! shellcheck "$script"; then
                SHELLCHECK_FAILED=1
            fi
        done
        if [ $SHELLCHECK_FAILED -eq 1 ]; then
            echo "‚ùå Shellcheck found issues! Please fix them before committing."
            CHECKS_FAILED=1
        else
            echo "‚úÖ No shell script issues found!"
        fi
    else
        echo "‚ö†Ô∏è  Shellcheck not found locally. Skipping shell script linting."
        echo "Install: brew install shellcheck (macOS) or apt-get install shellcheck (Ubuntu)"
    fi
fi

# GitHub workflow validation
if [ -n "$STAGED_GH_WORKFLOWS" ]; then
    echo "üîÑ Validating GitHub workflows..."

    if command -v actionlint >/dev/null 2>&1; then
        echo "Running GitHub workflow validation with actionlint..."
        GH_VALIDATION_FAILED=0
        for workflow in $STAGED_GH_WORKFLOWS; do
            if ! actionlint "$workflow" >/dev/null 2>&1; then
                echo "‚ùå GitHub workflow validation failed for $workflow"
                actionlint "$workflow" 2>&1
                GH_VALIDATION_FAILED=1
                CHECKS_FAILED=1
            fi
        done
        if [ $GH_VALIDATION_FAILED -eq 0 ]; then
            echo "‚úÖ All GitHub workflows are valid!"
        fi
    else
        echo "‚ö†Ô∏è  actionlint not found locally. Skipping workflow validation."
        echo "Install: brew install actionlint (macOS) or go install github.com/rhysd/actionlint/cmd/actionlint@latest"
    fi
fi

# Docker build checks
if [ -n "$STAGED_DOCKER_FILES" ]; then
    echo "üê≥ Running Docker build checks..."

    if command -v docker >/dev/null 2>&1; then
        echo "Running Docker build checks..."
        DOCKER_VALIDATION_FAILED=0
        for dockerfile in $STAGED_DOCKER_FILES; do
            if echo "$dockerfile" | grep -q "Dockerfile"; then
                dockerfile_dir=$(dirname "$dockerfile")
                [ "$dockerfile_dir" = "." ] && dockerfile_dir="."
                if ! docker build --check --file "$dockerfile" "$dockerfile_dir" >/dev/null 2>&1; then
                    echo "‚ùå Docker build check failed for $dockerfile"
                    DOCKER_VALIDATION_FAILED=1
                    CHECKS_FAILED=1
                fi
            elif echo "$dockerfile" | grep -q "docker-compose"; then
                if ! docker compose config >/dev/null 2>&1; then
                    echo "‚ùå Docker compose config validation failed for $dockerfile"
                    DOCKER_VALIDATION_FAILED=1
                    CHECKS_FAILED=1
                fi
            fi
        done
        if [ $DOCKER_VALIDATION_FAILED -eq 0 ]; then
            echo "‚úÖ All Docker configurations are valid!"
        fi
    else
        echo "‚ö†Ô∏è  Docker not found locally. Skipping Docker build checks."
        echo "Install: https://docs.docker.com/get-docker/"
    fi
fi

# Secret scanning with ripsecrets
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)
if [ -n "$STAGED_FILES" ]; then
    echo "üîê Running secret scanning..."

    if command -v ripsecrets >/dev/null 2>&1; then
        echo "Scanning for secrets in staged files..."
        # shellcheck disable=SC2086
        if ! ripsecrets --strict-ignore $STAGED_FILES 2>&1; then
            echo "‚ùå Potential secrets detected! Please review and remove them before committing."
            echo "To ignore specific patterns, add them to .secretsignore"
            CHECKS_FAILED=1
        else
            echo "‚úÖ No secrets detected!"
        fi
    else
        echo "‚ö†Ô∏è  ripsecrets not found locally. Skipping secret scanning."
        echo "Install: cargo install ripsecrets"
        echo "Docs: https://github.com/sirwart/ripsecrets"
    fi
fi

# Check if we have any staged files but no appropriate tools
if [ -z "$STAGED_TS_FILES" ] && [ -z "$STAGED_PY_FILES" ] && [ -z "$STAGED_JSON_FILES" ] && [ -z "$STAGED_SH_FILES" ] && [ -z "$STAGED_GH_WORKFLOWS" ] && [ -z "$STAGED_DOCKER_FILES" ]; then
    echo "‚ÑπÔ∏è  No files requiring validation staged for commit."
    exit 0
fi

# Exit with error if any checks failed
if [ $CHECKS_FAILED -eq 1 ]; then
    echo ""
    echo "‚ùå Pre-commit checks failed! Please fix the issues above before committing."
    exit 1
fi

echo ""
echo "‚úÖ All pre-commit checks passed!"
exit 0
