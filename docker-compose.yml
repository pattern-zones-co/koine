name: koine

services:
  koine:
    image: ghcr.io/pattern-zones-co/koine:${KOINE_VERSION:-latest}
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "127.0.0.1:${GATEWAY_PORT:-3100}:3100"
    environment:
      PORT: 3100
      # HOME required for Claude CLI to find its config directory
      HOME: /home/bun
      # Authentication for the gateway API
      CLAUDE_CODE_GATEWAY_API_KEY: ${CLAUDE_CODE_GATEWAY_API_KEY:-}
      # Claude authentication
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      CLAUDE_CODE_OAUTH_TOKEN: ${CLAUDE_CODE_OAUTH_TOKEN:-}
      # Concurrency limits
      KOINE_MAX_STREAMING_CONCURRENT: ${KOINE_MAX_STREAMING_CONCURRENT:-3}
      KOINE_MAX_NONSTREAMING_CONCURRENT: ${KOINE_MAX_NONSTREAMING_CONCURRENT:-5}
      # Tool restrictions (JSON array format, e.g., '["Read","Glob","Grep"]')
      # Gateway-level restrictions that SDK requests cannot bypass
      KOINE_ALLOWED_TOOLS: ${KOINE_ALLOWED_TOOLS:-}
      KOINE_DISALLOWED_TOOLS: ${KOINE_DISALLOWED_TOOLS:-}
    volumes:
      # Named volume for Claude CLI data
      - koine-data:/home/bun/.claude
      # WARNING: Bind-mounting ~/.claude is NOT SAFE for production.
      # It exposes credentials AND links all user-scoped Claude Code config
      # (slash commands, skills, MCP servers, etc.) which may be inappropriate.
      # Only use for local development/testing. For production:
      # - Set ANTHROPIC_API_KEY in .env (recommended for automation)
      # - Use project-scoped assets only (future: build-time asset mounting)
    # Security hardening
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    # Note: read_only disabled because Claude CLI needs to write to /home/bun/.claude.json
    # Other security hardening (no-new-privileges, cap_drop) remains in place
    read_only: false
    tmpfs:
      - /tmp:mode=1777,size=100m
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3100/health"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  koine-data:
